<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Types Admin - DAS Quote System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-800 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">DAS</span>
                        </div>
                        <span class="text-xl font-semibold text-slate-800">Quote System</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="customer-types-admin.html" class="px-4 py-2 text-sm font-medium text-blue-800 rounded-lg hover:bg-blue-100 transition-colors">
                        Customer Types
                    </a>
                    <a href="index.html" class="px-4 py-2 text-sm font-medium text-white bg-blue-800 rounded-lg hover:bg-blue-900 transition-colors">
                        New Quote
                    </a>
                    <div class="w-8 h-8 bg-slate-300 rounded-full"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="admin-app" class="p-6 max-w-6xl mx-auto">
            <h1 class="text-2xl font-bold mb-6">Customer Types & Discount Matrix Admin</h1>
            
            <!-- Loading spinner shown while data loads -->
            <div id="loading-spinner" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-800"></div>
            </div>
            
            <div id="admin-content" class="grid grid-cols-1 md:grid-cols-3 gap-6" style="display: none;">
                <!-- Left sidebar - Customer Types List -->
                <div class="md:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Customer Types</h2>
                            <button
                                id="add-new-btn"
                                class="px-3 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700"
                            >
                                Add New
                            </button>
                        </div>
                        
                        <!-- Customer Types List -->
                        <div id="customer-types-list" class="space-y-2 max-h-[600px] overflow-y-auto">
                            <!-- Customer types will be populated here -->
                        </div>
                        
                        <!-- New Customer Type Form -->
                        <div id="new-customer-form" class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50" style="display: none;">
                            <h3 class="font-medium mb-3">Add New Customer Type</h3>
                            <form id="add-group-form" class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-700 mb-1">Code</label>
                                    <input
                                        type="text"
                                        id="new-group-code"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        placeholder="P43-SYS-INT"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700 mb-1">Name</label>
                                    <input
                                        type="text"
                                        id="new-group-name"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        placeholder="System Integrator"
                                    />
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button
                                        type="button"
                                        id="cancel-new-group"
                                        class="px-3 py-1 border border-gray-300 text-gray-700 rounded-md"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                                    >
                                        Save
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Right panel - Discount Matrix Editor -->
                <div class="md:col-span-2">
                    <div id="discount-editor" class="bg-white rounded-lg shadow-md p-4" style="display: none;">
                        <h2 class="text-lg font-semibold mb-4">
                            Edit Discounts for <span id="selected-group-name"></span>
                        </h2>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Product Group
                                        </th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Discount %
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="discount-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Discount rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 flex justify-end">
                            <button
                                id="save-discounts-btn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            >
                                Save Discounts
                            </button>
                        </div>
                    </div>

                    <div id="no-selection" class="bg-white rounded-lg shadow-md p-8 flex flex-col items-center justify-center h-64">
                        <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                        </svg>
                        <p class="text-gray-500 text-lg">
                            Select a customer type from the list to edit discounts
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center text-sm text-slate-500">
                <p>&copy; 2024 Digital Access Solutions. Professional quote generation system.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://rhgozgxdpmymqblzfmcx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoZ296Z3hkcG15bXFibHpmbWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTg2MTUsImV4cCI6MjA3NjE3NDYxNX0.06NOpqVTA02ZgspDrffB2-UnBFAHbaSPJJevw7l3-0Q';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // State management
        const state = {
            customerGroups: [],
            productGroups: [],
            discountMatrix: {},
            selectedGroup: null,
            loading: true,
            saving: false
        };

        // DOM elements
        const elements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            adminContent: document.getElementById('admin-content'),
            customerTypesList: document.getElementById('customer-types-list'),
            discountEditor: document.getElementById('discount-editor'),
            noSelection: document.getElementById('no-selection'),
            selectedGroupName: document.getElementById('selected-group-name'),
            discountTable: document.getElementById('discount-table'),
            addNewBtn: document.getElementById('add-new-btn'),
            newCustomerForm: document.getElementById('new-customer-form'),
            addGroupForm: document.getElementById('add-group-form'),
            newGroupCode: document.getElementById('new-group-code'),
            newGroupName: document.getElementById('new-group-name'),
            cancelNewGroup: document.getElementById('cancel-new-group'),
            saveDiscountsBtn: document.getElementById('save-discounts-btn')
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Add new customer type button
            elements.addNewBtn.addEventListener('click', () => {
                elements.newCustomerForm.style.display = 'block';
            });

            // Cancel new customer type form
            elements.cancelNewGroup.addEventListener('click', () => {
                elements.newCustomerForm.style.display = 'none';
                elements.newGroupCode.value = '';
                elements.newGroupName.value = '';
            });

            // Add new customer type form submission
            elements.addGroupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewGroup();
            });

            // Save discounts button
            elements.saveDiscountsBtn.addEventListener('click', saveDiscounts);
        }

        // Load all data from Supabase
        async function loadData() {
            state.loading = true;
            updateUI();

            try {
                // Load customer groups
                const { data: groupData, error: groupError } = await supabase
                    .from('customer_groups')
                    .select('id, code, name')
                    .order('name');
                
                if (groupError) throw groupError;
                state.customerGroups = groupData || [];
                
                // Load unique product discount groups
                const { data: productData, error: productError } = await supabase
                    .from('discount_matrix')
                    .select('product_discount_group')
                    .order('product_discount_group');
                
                if (productError) throw productError;
                state.productGroups = [...new Set(productData.map(p => p.product_discount_group))];
                
                // Load the full discount matrix
                const { data: matrixData, error: matrixError } = await supabase
                    .from('discount_matrix')
                    .select('id, product_discount_group, customer_group_id, discount_percentage');
                
                if (matrixError) throw matrixError;
                
                // Organize matrix data by customer and product
                const matrix = {};
                state.customerGroups.forEach(group => {
                    matrix[group.id] = {};
                    state.productGroups.forEach(productGroup => {
                        const entry = matrixData.find(
                            item => item.customer_group_id === group.id && 
                                item.product_discount_group === productGroup
                        );
                        
                        matrix[group.id][productGroup] = entry ? {
                            id: entry.id,
                            discount_percentage: entry.discount_percentage
                        } : {
                            id: null,
                            discount_percentage: 0
                        };
                    });
                });
                
                state.discountMatrix = matrix;
                state.loading = false;
                updateUI();
            } catch (error) {
                console.error('Error loading admin data:', error);
                alert('Failed to load data. Please try again.');
                state.loading = false;
                updateUI();
            }
        }

        // Select a customer group
        function selectGroup(group) {
            state.selectedGroup = group;
            updateUI();
        }

        // Add a new customer group
        async function addNewGroup() {
            const code = elements.newGroupCode.value.trim();
            const name = elements.newGroupName.value.trim();

            if (!code || !name) {
                alert('Please fill in both code and name');
                return;
            }
            
            state.saving = true;
            updateUI();

            try {
                // Insert the new customer group
                const { data, error } = await supabase
                    .from('customer_groups')
                    .insert({
                        code: code,
                        name: name
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Initialize default discounts (all 0%)
                const defaultDiscounts = {};
                state.productGroups.forEach(productGroup => {
                    defaultDiscounts[productGroup] = {
                        id: null,
                        discount_percentage: 0
                    };
                });
                
                // Update local state
                state.customerGroups.push(data);
                state.discountMatrix[data.id] = defaultDiscounts;
                
                // Reset form and close it
                elements.newGroupCode.value = '';
                elements.newGroupName.value = '';
                elements.newCustomerForm.style.display = 'none';
                
                // Select the new group for editing
                state.selectedGroup = data;
                
                alert('New customer type added successfully!');
            } catch (error) {
                console.error('Error adding customer group:', error);
                alert('Failed to add customer type. Please try again.');
            } finally {
                state.saving = false;
                updateUI();
            }
        }

        // Delete a customer group
        async function deleteGroup(group) {
            if (!confirm(`Are you sure you want to delete ${group.name}? This will also delete all associated discounts.`)) {
                return;
            }
            
            state.saving = true;
            updateUI();

            try {
                // First delete related discount matrix entries
                const { error: matrixError } = await supabase
                    .from('discount_matrix')
                    .delete()
                    .eq('customer_group_id', group.id);
                
                if (matrixError) throw matrixError;
                
                // Then delete the customer group
                const { error: groupError } = await supabase
                    .from('customer_groups')
                    .delete()
                    .eq('id', group.id);
                
                if (groupError) throw groupError;
                
                // Update local state
                state.customerGroups = state.customerGroups.filter(g => g.id !== group.id);
                
                // If the deleted group was selected, clear selection
                if (state.selectedGroup && state.selectedGroup.id === group.id) {
                    state.selectedGroup = null;
                }
                
                alert('Customer type deleted successfully!');
            } catch (error) {
                console.error('Error deleting customer group:', error);
                alert('Failed to delete customer type. Please try again.');
            } finally {
                state.saving = false;
                updateUI();
            }
        }

        // Update a discount percentage
        function updateDiscount(productGroup, newValue) {
            if (!state.selectedGroup) return;
            
            state.discountMatrix[state.selectedGroup.id][productGroup].discount_percentage = parseFloat(newValue) || 0;
            updateUI();
        }

        // Save discount changes
        async function saveDiscounts() {
            if (!state.selectedGroup) return;
            
            state.saving = true;
            updateUI();

            try {
                // Prepare updates and inserts
                const updates = [];
                const inserts = [];
                
                Object.entries(state.discountMatrix[state.selectedGroup.id]).forEach(([productGroup, data]) => {
                    if (data.id) {
                        // Existing record - update
                        updates.push({
                            id: data.id,
                            discount_percentage: data.discount_percentage
                        });
                    } else if (data.discount_percentage > 0) {
                        // New record with discount - insert
                        inserts.push({
                            customer_group_id: state.selectedGroup.id,
                            product_discount_group: productGroup,
                            discount_percentage: data.discount_percentage
                        });
                    }
                });
                
                // Execute updates if any
                if (updates.length > 0) {
                    const { error: updateError } = await supabase
                        .from('discount_matrix')
                        .upsert(updates);
                    
                    if (updateError) throw updateError;
                }
                
                // Execute inserts if any
                if (inserts.length > 0) {
                    const { error: insertError } = await supabase
                        .from('discount_matrix')
                        .insert(inserts);
                    
                    if (insertError) throw insertError;
                }
                
                alert('Discounts saved successfully!');
                // Reload data to get new IDs
                loadData();
            } catch (error) {
                console.error('Error saving discounts:', error);
                alert('Failed to save discounts. Please try again.');
                state.saving = false;
                updateUI();
            }
        }

        // Update the UI based on current state
        function updateUI() {
            // Show/hide loading spinner
            elements.loadingSpinner.style.display = state.loading ? 'flex' : 'none';
            elements.adminContent.style.display = state.loading ? 'none' : 'grid';
            
            if (state.loading) return;
            
            // Render customer types list
            renderCustomerTypesList();
            
            // Render discount editor
            if (state.selectedGroup) {
                elements.discountEditor.style.display = 'block';
                elements.noSelection.style.display = 'none';
                elements.selectedGroupName.textContent = state.selectedGroup.name;
                renderDiscountTable();
            } else {
                elements.discountEditor.style.display = 'none';
                elements.noSelection.style.display = 'flex';
            }
            
            // Disable buttons during saving
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = state.saving;
                if (state.saving) {
                    button.classList.add('opacity-50');
                } else {
                    button.classList.remove('opacity-50');
                }
            });
        }

        // Render the list of customer types
        function renderCustomerTypesList() {
            elements.customerTypesList.innerHTML = '';
            
            state.customerGroups.forEach(group => {
                const isSelected = state.selectedGroup && state.selectedGroup.id === group.id;
                
                const groupEl = document.createElement('div');
                groupEl.className = `p-3 rounded-md cursor-pointer flex justify-between items-center ${
                    isSelected
                        ? 'bg-blue-100 border border-blue-300' 
                        : 'bg-gray-50 hover:bg-gray-100'
                }`;
                groupEl.onclick = () => selectGroup(group);
                
                groupEl.innerHTML = `
                    <div>
                        <p class="font-medium">${group.name}</p>
                        <p class="text-sm text-gray-500">${group.code}</p>
                    </div>
                    <button
                        class="text-red-600 hover:text-red-800"
                        onclick="event.stopPropagation(); deleteGroup(${JSON.stringify(group)})"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                elements.customerTypesList.appendChild(groupEl);
            });
        }

        // Render the discount table
        function renderDiscountTable() {
            elements.discountTable.innerHTML = '';
            
            state.productGroups.forEach(productGroup => {
                const discountData = state.discountMatrix[state.selectedGroup.id][productGroup];
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="font-medium">${productGroup}</div>
                        <div class="text-xs text-gray-500">
                            ${productGroup.includes('-SOFT') ? 'Software' : 'Hardware'}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex justify-end items-center">
                            <input
                                type="number"
                                min="0"
                                max="100"
                                value="${discountData?.discount_percentage || 0}"
                                onchange="updateDiscount('${productGroup}', this.value)"
                                class="w-16 px-2 py-1 text-right border border-gray-300 rounded-md"
                            />
                            <span class="ml-1">%</span>
                        </div>
                    </td>
                `;
                
                elements.discountTable.appendChild(row);
            });
        }

        // Make functions available globally for event handlers
        window.selectGroup = selectGroup;
        window.deleteGroup = deleteGroup;
        window.updateDiscount = updateDiscount;
    </script>
</body>
</html>